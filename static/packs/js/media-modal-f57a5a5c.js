var Q=Object.defineProperty;var Z=(o,n,e)=>n in o?Q(o,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[n]=e;var c=(o,n,e)=>(Z(o,typeof n!="symbol"?n+"":n,e),e);import{v as J}from"./arrow-right-b75290c7.js";import{r as g,_ as i,R as w,ay as ee,dg as te,a1 as f,c as se,q as ie,u as ne,aN as ae,p as oe,K as re,Z as le,aO as ce,aF as de,aQ as ue,a8 as he,H as L,aI as M,ab as ve,c7 as A,dt as me,db as ge,n as pe,du as fe,aR as xe}from"../index-961d4ed1.js";import{V as we,a as Ce}from"./index-a24feb75.js";import{v as ye}from"./arrows-minimize-7c27a12c.js";import{v as be}from"./download-ac53125a.js";import{R as ke}from"./index-c8dcab95.js";import Se from"./index-05a7d34c.js";import{T as Ee}from"./thread-0ef56bd7.js";import"./volume-08f8a8f1.js";import"./media-aspect-ratio-df6a7bb1.js";import"./warning-07d0fac9.js";import"./scrollable-list-74021d3b.js";import"./index-c72bc579.js";import"./load-more-1869fbc1.js";import"./pending-status-d95ac051.js";import"./poll-preview-bd47b324.js";import"./noop-33ff36b4.js";import"./status-container-8c0c48ff.js";const Ie=o=>{let{src:n,alt:e,time:s,controls:r,muted:h,onClick:d}=o;const a=g.useRef(null);g.useEffect(()=>{var m;const v=()=>{s&&(a.current.currentTime=s)};return(m=a.current)==null||m.addEventListener("loadeddata",v),()=>{var p;(p=a.current)==null||p.removeEventListener("loadeddata",v)}},[a.current]);const l=v=>{v.stopPropagation();const m=d;m&&m()},u={};return te()&&(u.playsInline=!0),i("div",{className:"extended-video-player"},void 0,w.createElement("video",ee({ref:a,src:n,autoPlay:!0,role:"button",tabIndex:0,"aria-label":e,title:e,muted:h,controls:r,loop:!r,onClick:l},u)))},q=1,_e=4,Ne=(o,n)=>({x:(o.clientX+n.clientX)/2,y:(o.clientY+n.clientY)/2}),H=(o,n)=>Math.sqrt(Math.pow(o.clientX-n.clientX,2)+Math.pow(o.clientY-n.clientY,2)),Le=(o,n,e)=>Math.min(n,Math.max(o,e));class O extends w.PureComponent{constructor(){super(...arguments);c(this,"state",{scale:q});c(this,"container",null);c(this,"image",null);c(this,"lastDistance",0);c(this,"handleTouchStart",e=>{if(e.touches.length!==2)return;const[s,r]=Array.from(e.touches);this.lastDistance=H(s,r)});c(this,"handleTouchMove",e=>{if(!this.container)return;const{scrollTop:s,scrollHeight:r,clientHeight:h}=this.container;if(e.touches.length===1&&s!==r-h){e.stopPropagation();return}if(e.touches.length!==2)return;e.preventDefault(),e.stopPropagation();const[d,a]=Array.from(e.touches),l=H(d,a),u=Ne(d,a),v=Le(q,_e,this.state.scale*l/this.lastDistance);this.zoom(v,u),this.lastDistance=l});c(this,"handleClick",e=>{e.stopPropagation();const s=this.props.onClick;s&&s(e)});c(this,"setContainerRef",e=>{this.container=e});c(this,"setImageRef",e=>{this.image=e})}componentDidMount(){var e,s;(e=this.container)==null||e.addEventListener("touchstart",this.handleTouchStart),(s=this.container)==null||s.addEventListener("touchmove",this.handleTouchMove,{passive:!1})}componentWillUnmount(){var e,s;(e=this.container)==null||e.removeEventListener("touchstart",this.handleTouchStart),(s=this.container)==null||s.removeEventListener("touchend",this.handleTouchMove)}zoom(e,s){if(!this.container)return;const{scale:r}=this.state,{scrollLeft:h,scrollTop:d}=this.container,a=(h+s.x)*e/r-s.x,l=(d+s.y)*e/r-s.y;this.setState({scale:e},()=>{this.container&&(this.container.scrollLeft=a,this.container.scrollTop=l)})}render(){const{alt:e,src:s}=this.props,{scale:r}=this.state,h=r===1?"hidden":"scroll";return w.createElement("div",{className:"zoomable-image",ref:this.setContainerRef,style:{overflow:h}},w.createElement("img",{role:"presentation",ref:this.setImageRef,alt:e,title:e,src:s,style:{transform:`scale(${r})`,transformOrigin:"0 0"},onClick:this.handleClick}))}}c(O,"defaultProps",{alt:"",width:null,height:null});class V extends w.PureComponent{constructor(){super(...arguments);c(this,"state",{loading:!0,error:!1,width:null});c(this,"removers",[]);c(this,"canvas",null);c(this,"_canvasContext",null);c(this,"loadPreviewCanvas",e=>{let{previewSrc:s,width:r,height:h}=e;return new Promise((d,a)=>{const l=new Image,u=()=>{l.removeEventListener("error",v),l.removeEventListener("load",m)},v=()=>{u(),a()},m=()=>{var p;u(),(p=this.canvasContext)==null||p.drawImage(l,0,0,r||0,h||0),d()};l.addEventListener("error",v),l.addEventListener("load",m),l.src=s||"",this.removers.push(u)})});c(this,"loadOriginalImage",e=>{let{src:s}=e;return new Promise((r,h)=>{const d=new Image,a=()=>{d.removeEventListener("error",l),d.removeEventListener("load",u)},l=()=>{a(),h()},u=()=>{a(),r()};d.addEventListener("error",l),d.addEventListener("load",u),d.src=s,this.removers.push(a)})});c(this,"setCanvasRef",e=>{this.canvas=e,e&&this.setState({width:e.offsetWidth})})}get canvasContext(){return this.canvas?(this._canvasContext=this._canvasContext||this.canvas.getContext("2d"),this._canvasContext):null}componentDidMount(){this.loadImage(this.props)}componentDidUpdate(e){e.src!==this.props.src&&this.loadImage(this.props)}componentWillUnmount(){this.removeEventListeners()}loadImage(e){this.removeEventListeners(),this.setState({loading:!0,error:!1}),Promise.all([e.previewSrc&&this.loadPreviewCanvas(e),this.hasSize()&&this.loadOriginalImage(e)].filter(Boolean)).then(()=>{this.setState({loading:!1,error:!1}),this.clearPreviewCanvas()}).catch(()=>this.setState({loading:!1,error:!0}))}clearPreviewCanvas(){if(this.canvas&&this.canvasContext){const{width:e,height:s}=this.canvas;this.canvasContext.clearRect(0,0,e,s)}}removeEventListeners(){this.removers.forEach(e=>e()),this.removers=[]}hasSize(){const{width:e,height:s}=this.props;return typeof e=="number"&&typeof s=="number"}render(){const{alt:e,src:s,width:r,height:h,onClick:d}=this.props,{loading:a}=this.state,l=f("image-loader",{"image-loader--loading":a,"image-loader--amorphous":!this.hasSize()});return i("div",{className:l},void 0,a?w.createElement("canvas",{className:"image-loader__preview-canvas",ref:this.setCanvasRef,width:r,height:h}):i(O,{alt:e,src:s,onClick:d}))}}c(V,"defaultProps",{alt:"",width:null,height:null});const C=pe({close:{id:"lightbox.close",defaultMessage:"Close"},expand:{id:"lightbox.expand",defaultMessage:"Expand"},minimize:{id:"lightbox.minimize",defaultMessage:"Minimize"},next:{id:"lightbox.next",defaultMessage:"Next"},previous:{id:"lightbox.previous",defaultMessage:"Previous"}}),Me={width:"100%",height:"100%"},Pe={alignItems:"center"},Ze=o=>{const{media:n,status:e,onClose:s,time:r=0}=o,h=se(),d=ie(),a=ne(),l=g.useCallback(ae(),[]),u=oe(t=>l(t,{id:e==null?void 0:e.id})),[v,m]=g.useState(!!e),[p,P]=g.useState(),[y,S]=g.useState(null),[j,F]=g.useState(!1),[x,W]=g.useState(!e),E=n.size>1,X=t=>S(t%n.size),R=()=>S((k()+1)%n.size),z=()=>S((n.size+k()-1)%n.size),b=j?"pointer-events-none opacity-0":"",D=t=>{switch(t.key){case"ArrowLeft":z(),t.preventDefault(),t.stopPropagation();break;case"ArrowRight":R(),t.preventDefault(),t.stopPropagation();break}},B=()=>{const t=E?n.get(y):n.get(0);window.open(t==null?void 0:t.url)},k=()=>y!==null?y:o.index,T=()=>{F(t=>!t&&fe())},K=t=>{e&&t.button===0&&!(t.ctrlKey||t.metaKey)&&(t.preventDefault(),d.push(`/@${e.account.acct}/posts/${e==null?void 0:e.id}`),s())},U=n.map((t,I)=>{const _=t.meta.getIn(["original","width"])||void 0,N=t.meta.getIn(["original","height"])||void 0,G=e&&i("a",{href:e.url,onClick:K},void 0,i(re,{id:"lightbox.view_context",defaultMessage:"View context"}));return t.type==="image"?i(V,{previewSrc:t.preview_url,src:t.url,width:_,height:N,alt:t.description,onClick:T},t.url):t.type==="video"?i(we,{preview:t.preview_url,blurhash:t.blurhash,src:t.url,width:_,height:N,startTime:r,detailed:!0,autoFocus:I===k(),link:G,alt:t.description,visible:!0},t.url):t.type==="audio"?i(Se,{src:t.url,alt:t.description,poster:t.preview_url!==t.url?t.preview_url:e==null?void 0:e.getIn(["account","avatar_static"]),backgroundColor:t.meta.getIn(["colors","background"]),foregroundColor:t.meta.getIn(["colors","foreground"]),accentColor:t.meta.getIn(["colors","accent"]),duration:t.meta.getIn(["original","duration"],0)},t.url):t.type==="gifv"?i(Ie,{src:t.url,muted:!0,controls:!1,width:_,height:N,alt:t.description,onClick:T},t.preview_url):null}).toArray(),Y=g.useCallback(le(()=>{p&&e&&h(ce(e==null?void 0:e.id,p)).then(t=>{let{next:I}=t;P(I)}).catch(()=>{})},300,{leading:!0}),[p,e]),$=async()=>{const{next:t}=await h(xe(e==null?void 0:e.id));P(t)};if(g.useEffect(()=>{$().then(()=>{m(!0)}).catch(()=>{m(!0)})},[e==null?void 0:e.id]),g.useEffect(()=>(window.addEventListener("keydown",D,!1),()=>{window.removeEventListener("keydown",D)}),[y]),e){if(!u&&v)return i(de,{});if(!u)return i(ue,{})}return i("div",{className:"media-modal pointer-events-auto fixed inset-0 z-[9999] h-full bg-gray-900/90"},void 0,i("div",{className:"absolute inset-0",role:"presentation"},void 0,i(he,{onClick:t=>{t.target.tagName==="DIV"&&s()},className:f("fixed inset-0 h-full grow transition-all",{"xl:pr-96":!x,"xl:pr-0":x}),justifyContent:"between"},void 0,i(L,{alignItems:"center",justifyContent:"between",className:f("flex-[0_0_60px] p-4 transition-opacity",b)},void 0,i(M,{title:a.formatMessage(C.close),src:ve,onClick:s,theme:"dark",className:"!p-1.5 hover:scale-105 hover:bg-gray-900",iconClassName:"h-5 w-5"}),i(L,{alignItems:"center",space:2},void 0,i(M,{src:be,theme:"dark",className:"!p-1.5 hover:scale-105 hover:bg-gray-900",iconClassName:"h-5 w-5",onClick:B}),e&&i(M,{src:x?ye:Ce,title:a.formatMessage(x?C.minimize:C.expand),theme:"dark",className:"hidden !p-1.5 hover:scale-105 hover:bg-gray-900 xl:block",iconClassName:"h-5 w-5",onClick:()=>W(!x)}))),i("div",{className:"relative h-[calc(100vh-120px)] w-full grow"},void 0,E&&i("div",{className:f("absolute inset-y-0 left-5 z-10 flex items-center transition-opacity",b)},void 0,i("button",{tabIndex:0,className:"flex h-10 w-10 items-center justify-center rounded-full bg-gray-900 text-white",onClick:z,"aria-label":a.formatMessage(C.previous)},void 0,i(A,{src:me,className:"h-5 w-5"}))),i(ke,{style:Me,containerStyle:Pe,onChangeIndex:X,index:k()},void 0,U),E&&i("div",{className:f("absolute inset-y-0 right-5 z-10 flex items-center transition-opacity",b)},void 0,i("button",{tabIndex:0,className:"flex h-10 w-10 items-center justify-center rounded-full bg-gray-900 text-white",onClick:R,"aria-label":a.formatMessage(C.next)},void 0,i(A,{src:J,className:"h-5 w-5"})))),u&&i(L,{justifyContent:"center",className:f("flex-[0_0_60px] transition-opacity",b)},void 0,i(ge,{status:u,space:"md",statusActionButtonTheme:"inverse"}))),u&&i("div",{className:f("-right-96 hidden bg-white transition-all xl:fixed xl:inset-y-0 xl:right-0 xl:flex xl:w-96 xl:flex-col",{"xl:!-right-96":x})},void 0,i(Ee,{status:u,withMedia:!1,useWindowScroll:!1,itemClassName:"px-4",next:p,handleLoadMore:Y}))))};export{Ze as default};
